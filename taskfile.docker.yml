version: "3"

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list-all

  up:
    desc: Start all services
    cmds:
      - docker compose up -d

  postgres:up:
    desc: Start postgres database
    cmds:
      - docker compose up -d postgres

  migrator:up:
    desc: Start migrator
    cmds:
      - docker compose up -d migrator

  backend:up:
    desc: Start backend
    cmds:
      - docker compose up -d backend

  down:
    desc: Stop all services
    cmds:
      - docker compose down

  postgres:down:
    desc: Stop postgres database
    cmds:
      - docker compose down postgres

  migrator:down:
    desc: Stop migrator
    cmds:
      - docker compose down migrator

  backend:down:
    desc: Stop backend
    cmds:
      - docker compose down backend

  build:
    desc: Build all services
    cmds:
      - docker compose build

  postgres:build:
    desc: Build postgres database
    cmds:
      - docker compose build postgres

  migrator:build:
    desc: Build migrator
    cmds:
      - docker compose pull migrator

  backend:build:
    desc: Build backend
    cmds:
      - docker compose build backend

  postgres:logs:
    desc: Show postgres database logs
    cmds:
      - docker compose logs postgres

  migrator:logs:
    desc: Show migrator logs
    cmds:
      - docker compose logs migrator

  backend:logs:
    desc: Show backend logs
    cmds:
      - docker compose logs backend

  postgres:inside:
    desc: Open postgres database shell
    cmds:
      - docker compose exec -it postgres bash

  migrator:inside:
    desc: Open migrator shell
    cmds:
      - docker compose exec -it migrator bash

  backend:inside:
    desc: Open backend shell
    cmds:
      - docker compose exec -it backend bash

  ps:
    desc: Show all services
    cmds:
      - docker compose ps

  # Production deployment tasks
  prod:up:
    desc: Start production services
    cmds:
      - docker compose -f docker-compose.prod.yml up -d

  prod:down:
    desc: Stop production services
    cmds:
      - docker compose -f docker-compose.prod.yml down

  prod:build:
    desc: Build production services
    cmds:
      - docker compose -f docker-compose.prod.yml build

  prod:deploy:
    desc: Deploy production (build and start)
    cmds:
      - |
        if [ ! -f .env ]; then
          if [ -f .env.sample ]; then
            echo "Warning: .env file not found. Copying from .env.sample"
            cp .env.sample .env
            echo "Note: Please edit .env with your production values if you haven't already."
          else
            echo "Error: .env file not found and .env.sample does not exist."
            exit 1
          fi
        fi
      - docker compose -f docker-compose.prod.yml down || true
      - docker compose -f docker-compose.prod.yml up -d --build
      - echo "Waiting for services to start..."
      - sleep 10
      - docker compose -f docker-compose.prod.yml ps

  prod:logs:
    desc: Show production logs
    cmds:
      - docker compose -f docker-compose.prod.yml logs -f {{.CLI_ARGS}}

  prod:restart:
    desc: Restart production services
    cmds:
      - docker compose -f docker-compose.prod.yml restart

  prod:health:
    desc: Check production service health
    cmds:
      - bash scripts/health-check.sh

  prod:status:
    desc: Show production service status
    cmds:
      - docker compose -f docker-compose.prod.yml ps
